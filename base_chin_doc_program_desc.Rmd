```{r page title, include=FALSE}
page_title <- "Base Period Documentation - Program Descriptions"
```

--- 
title: `r page_title`
author: ""
date: ""
description: "Getting to know the Fishery Regulation Assessment Model (FRAM)"
editor_options: 
  chunk_output_type: console
---

# Program Descriptions
Angelika

## FRAMBuilder

### Requirements

## [Main Calibration Program]{#CP}
For the development of the new base period, the original calibration programs were rewritten using "Visual Studio.net". The original programs were developped in QBasic and fragmented into many separate programs, requiring substantial user effort to create and edit program input files. Various processes were undocumented and disjointed.  In many cases the output from one program was used to create the input file for the next program in the estimation process. Any data or selection changes usually resulted in re-running all components of the system. The new program was written in Visual Basic and consolidated the entire calibration into one application. Input and output is now stored in the same Access database. Data editing between runs is kept to a minimum. Once the required data is updated in the database, a new base period can be created in minutes.
The new program has two main functions:

* Produce all the output data needed to populate the FRAM model with a new base period<br>
The program can be run with 4 different options

    - Out-of-Base (OOB) run
    
    - First OOB then all-stocks run
    
    - All-stocks run
    
    - Run without escapement and fishery expansions
    
* Create a transfer database for easy import of base period data into the main FRAM database
The user has several options to create output

### Requirments
The code for the program is posted in a [GitHub repository](https://github.com/Angelikahagen/MainCalibrationProgram). <br>
To produce a new base period two files are required:

* Executable: MainCalibration.exe <br>
Please see [the GitHub repositiory](https://github.com/Angelikahagen/MainCalibrationProgram/blob/master/bin/x86/Debug/MainCalibration.exe) to download the executable.

* Access Calibration Database: CalibrationSupport_xxx.mdb. <br>
Please see chapter <a href="https://github.com/FRAMverse/fram_doc/tree/bp_documentation/docs/base_chin_doc_appendix.html#Database_Tables" target="_blank">Database Tables </a> for a description of the tables.
Please contact a member of the FRAM team at WDFW or NWIFC for assistance with
obtaining this file.

To transfer calibration output into FRAM an additional transfer database is required.

* Access Transfer Database: NewCalibrationBasePeriodTransfer.mdb<br>
Please contact a member of the FRAM team at WDFW or NWIFC for assistance with
obtaining this file.

### Prerequisites
Update all input database tables of the calibration database. These are listed in Appendix table <a href="https://framverse.github.io/fram_doc/base_chin_doc_appendix.html#Table_Description"> Table Description </a>.

Make sure that tables `CWT_AllOOB` and `CWTAll` contain the latest FRAMBuilder output.

### Considerations

For an OOB run the `FishScaler` table is updated in an iterative process whereupon calibration output is imported into FRAM, FRAM is run (see chapter <a href="https://framverse.github.io/fram_doc/base_chin_doc_program.html#Instructions_for_Producing_a_New_Base_Period_(specific)"> Instructions for Producing a New Base Period </a>) and updated fish scalers from these runs are pasted into the calibration database.

In order to update the <a href="https://framverse.github.io/fram_doc/base_chin_doc_glossary.html#Model-Stock_Proportion_(MSP)">MSP</a> conduct a "Total Run". There are three tables in the calibration database that exisit in a "marked version" and a "total version". These tables are `BasePeriodCatch`, `BasePeriodEscapements`, and `NonRetention`. When running a "TotalRun", the tables with the total (marked + unmarked) values, need to have these names, when running a "Marked Run" the marked tables need to have these names. This will sometimes require renaming `BasePeriodCatch_Tot` to `BasePeriodCatch`, `BasePeriodEscapements_Tot` to `BasePeriodEscapements`, and `NonRetention_Tot` to `NonRetention`. <br>
Run the calibration program. This will updated `ModelStockProportion` in table `BasePeriodCatch`. Before running the main (marked only) calibration, rename the tables with the marked values to the original table names. For more information visit sections <a href="https://framverse.github.io/fram_doc/base_chin_doc_calibration.html#Fishery Model_Stock_Proportion_(MSP)">Fishery Model Stock Proportion</a> and <a href="https://framverse.github.io/fram_doc/base_chin_doc_program_desc.html#Instructions_for_Producing_a_New_Base_Period_(specific)">Instructions for Producing a New Base Period</a>.

### Conducting a Run (generic)

Upon selecting the executable, the program opens to the Main Menu also titled "Start Form".

```{r MainMenu, echo = FALSE, fig.cap=c("Figure xxx. Main Menu"),fig.pos='H', out.height = "300px", out.width='400px'}

knitr::include_graphics("./images/CalProg1.JPG")

```

The user is presented with four run options.<br>

* Process only Out of Base Stocks
When this option is selected the program only processes OOB stocks. The user selects the database table with the OOB Frambuilder recoveries. The program runs <a href="https://framverse.github.io/fram_doc/base_chin_doc_calibration.html#Out-of-Base_Procedures" target="_blank">OOB procedures</a> to the step where OOB recoveries are merged over brood years. At this point the user has the option to provide brood year weights. If no weights are provided each year receives the same weight.
```{r Calib13, echo = FALSE, fig.cap=c("Figure xxx. Brood Year Weighting Menu"),fig.pos='H', out.height = "300px", out.width='400px'}

knitr::include_graphics("./images/CalProg13.JPG")

```
Selecting `Update` processes the new weights, `Cancel`clears out updated weights, and `Close`uses the existing (not updated) weights. Please see chapter <a href="https://framverse.github.io/fram_doc/base_chin_doc_calibration.html#Merge_OOB_CWTs_over_brood_years" target="_blank">Merging OOB CWTs over brood years</a>for more information about merging CWT recoveries.
After merging estimated CWT recoveries over brood years, the program saves them in table `CWTOOBMerged` of the calibration database. 

* Process Out of Base Stocks then All Stocks<br>
This option represents a typical calibration cycle that contains in-base as well as OOB stocks. The program first processes OOB recoveries, before merging them into the dataset with the in-base recoveries and conducting a calibration as described in the <a href="https://framverse.github.io/fram_doc/base_chin_doc_calibration.html" target="_blank">calibration </a> section of this documentation.

* Process only All Stocks<br>
If the calibration does not contain OOB stocks, then this option will produce a complete base period without running OOB procedures. 

* Cohort Reconstruction w/o expansions<br>
Selecting this option produces cohort reconstructions and base period exploitation rates without escapement and fishery expansions; i.e., expansions are set to 1. **Each stock can be processed independent of other stocks** as the program does not expand recoveries to match the catch of all the stocks in a fishery. This procedure is akin to how the <a href="https://framverse.github.io/fram_doc/calcs_glossary.html#Chinook_Technical_Committee_(CTC)" target="_blank">CTC</a> conducts its exploitation rate analysis. 

After selecting a run option the user presses the "Run" button. This will open the file selection menu.
```{r Calib2, echo = FALSE, fig.cap=c("Figure xxx. File Selection Menu"),fig.pos='H', out.height = "300px", out.width='400px'}

knitr::include_graphics("./images/CalProg2.JPG")

```

Select `Open Support File`. This brings up a file explorer. Navigate to the directory with the calibration support database, select, and press `Open`. You will be prompted to select the table with the CWT recoveries for the desired run type. 

```{r Calib3, echo = FALSE, fig.cap=c("Figure xxx. Prompt to Select CWT Table"),fig.pos='H', out.height = "400px", out.width='500px'}

knitr::include_graphics("./images/CalProg3.JPG")

```

The database table names and fields are loaded into the screen. Select the table and hit `Run`.

```{r Calib4, echo = FALSE, fig.cap=c("Figure xxx. Populated File Selection Menu"),fig.pos='H', out.height = "400px", out.width='500px'}

knitr::include_graphics("./images/CalProg4.JPG")

```

While the program runs, it may provide several feedback messages. The first message results from error check procedures. The program eliminates CWT recoveries of stocks without a legal population size for the age, fishery, and time step combination the recovery was made. The warning message prompts the user to examine an output file, errfile.txt, for more information about eliminated recoveries.

```{r Calib5, echo = FALSE, fig.cap=c("Figure xxx. Warning Message No Legal Population Size"),fig.pos='H', out.height = "200px", out.width='500px'}

knitr::include_graphics("./images/CalProg5.JPG")

```

Another warning message occurs if catch is missing for a fishery and time step that has actual or surrogate recoveries. Without catch, the program cannot produce base period exploitation rates. A small catch will remedy this situation and provide an exploitation rate without greatly affecting cohort sizes. This situation can occur for non-retention fisheries, where catch is illegal to retain, but BPERs are desirable to model non-retention impacts. These fisheries are usually modeled through the use of surrogate fisheries that provides the necessary CWT recoveries.

```{r Calib6, echo = FALSE, fig.cap=c("Figure xxx. Warning Message Missing Catch"),fig.pos='H', out.height = "200px", out.width='500px'}

knitr::include_graphics("./images/CalProg6.JPG")

```

A message is also produced for fisheries and time steps where base period catch exists, but CWT recoveries are lacking. These are usually fisheries that have designated surrogates. If this is not the case, a surrogate needs to be introduced.

```{r Calib7, echo = FALSE, fig.cap=c("Figure xxx. Warning Message Missing CWTs"),fig.pos='H', out.height = "200px", out.width='500px'}

knitr::include_graphics("./images/CalProg7.JPG")

```

When the run has completed in returns to the main menu where the user can exit the program or produce output for the newly created base period.

### Transferring Output

When selecting `Export` on the main menu screen, the program transfers new base period output into a separate database used to easily import the new base period into a FRAM database. At this stage, model output is converted from a marked 39 stock structure to a marked and unmarked 78 stock structure. Each stock is divided into an unmarked (uneven stock ID) and a marked (even stock ID) component, effectively doubling the number of stocks. The transfer function re-numbers the stocks such that the new stock number equals old stock number * 2 -1 for unmarked, and old stock number * 2 for marked. The new unmarked cohort size is the same as the marked cohort size, thus doubling cohort sizes. This is un-problematic as cohort sizes are recomputed at the beginning of every FRAM run. All other variables that have a stock-specific parameter (BPERs, growth functions, maturation rates, etc.) are also doubled to have values for unmarked stock components. The values are again recycled from the marked stock components. This handling follows one of the main modeling assumptions; that marked stock components are acceptable surrogates for unmarked populations. 

Select the name of an empty transfer database
```{r Calib8, echo = FALSE, fig.cap=c("Figure xxx. Transfer File Selection Menu"),fig.pos='H', out.height = "400px", out.width='600px'}

knitr::include_graphics("./images/CalProg8.JPG")

```

The program prompts the user to select the calibration database containing the base period data to be exported.
```{r Calib9, echo = FALSE, fig.cap=c("Figure xxx. Propmpt to select the calibration database"),fig.pos='H', out.height = "150px", out.width='300px'}

knitr::include_graphics("./images/CalProg9.JPG")

```

Select the desired base period and press `Transfer Selection Done`.
```{r Calib10, echo = FALSE, fig.cap=c("Figure xxx. Base Period Selection Screen"),fig.pos='H', out.height = "300px", out.width='400px'}

knitr::include_graphics("./images/CalProg10.JPG")

```

The user is prompted to rename the transfer database.
```{r Calib11, echo = FALSE, fig.cap=c("Figure xxx. Prompt to name the new transfer database"),fig.pos='H', out.height = "150px", out.width='300px'}

knitr::include_graphics("./images/CalProg11.JPG")

```

Enter a new filename into the name field of the file dialog screen and press `Save`.
```{r Calib12, echo = FALSE, fig.cap=c("Figure xxx. File Dialog Rename and Save Screen"),fig.pos='H', out.height = "350px", out.width='600px'}

knitr::include_graphics("./images/CalProg12.JPG")

```


#### Importing Base Period Data Into FRAM
A new base period can be imported into a FRAM Access database by selecting `FRAM Utilities` on the `Main Menu`. Next choose `Get Base Period Transfer`, select the transfer database and press `Open`. <br>
This opens the following window:
```{r BPImport, echo = FALSE, fig.cap=c("Figure xxx. Base Period Import Screen"),fig.pos='H', out.height = "300px", out.width='500px'}

knitr::include_graphics("./images/BPTransfer.JPG")

```

Fisheries and Time Steps are identical between the new and old base period. However, there are differences in Base Period Size Limits and Stocks.  Check the boxes for “Base Period Size Limits” and “Stocks” to also import this information, then select `Done`. <br>
The new base period will be added to the existing base period tables with a new (incremented by 1) base period ID. When data import is completed the "FRAM Utilities" page will reappear.<br>
To ensure the import was successful, it is good practice to check whether data exists for the new BasePeriodID in the appropriate tables.  The following tables include data from the base period dataset:

* AEQ

* BaseCohort

* BaseExploitationRate

* EncounterRateAdjustment

* FisheryModelStockProportion

* Growth

* IncidentalRate

* MaturationRate

* NaturalMortality

* ShakerMortRate

Now there are just a few additional steps needed to update the `StockVersion` and link runs to the newly imported base period.<br>
Retrieve the stock version number from FRAM's database. This number is located in the `Stock` table `StockVersion` field.<br>
Next, in the Access database, open the `BaseID` table and identify the `BasePeriodID` for the record that was just added (check the `DateCreated` field for help).  For this record, update the value in the `StockVersion` field to the value from the `Stock` table.<br>
Open the `RunID` table.  For any existing model runs stored in the database that you wish to run with the new base period data set, update the value in the `BasePeriodID` field to the new BaseID.<br>

### Code Description

### Instructions for Producing a New Base Period (specific)
The following instructions are specific to the steps needed to produce base period 7.1.

#### Compile and update data
Update all data needed for calibration and FRAM validation databases.

#### Produce Validation Runs
Validation runs must be completed with the newest year first, going backwards consecutively, because the 2s from 3s method designates abundance values for 2 year olds for a given year based upon the abundance values of 3 year olds in year + 1.

##### Normal Running Procedures

1. Open FRAM 

2. Click the green `Open Database` button. Select the desired validation run database and click `Open`. Select the desired year to run.

3. Click the green `Run Model` button. Ensure that the `Size Limit Fix` box is checked. Click the green `Run Model` button

4. Click the green `Post Season Run` button. Edit the number of iterations as you see fit (40 iterations is normally acceptable, but always double check results). Click the green `Start Iterations` button. Use TAMI Catches if this is your first set of validation runs for the data base.  Otherwise, do not use TAMI catches.

5. After BKFRAM is complete (this process generally takes 1-5 minutes), complete the “BKFRAM Targets vs. Outputs” QAQC as described [below](#QAQC).  If there were no errors during BKFRAM QAQC, continue to the next step. If there were errors, see the [Errors](#errors) section below.

6. Click the green `Save Model Run Inputs` button and on the next screen click the green `Replace Current Model Run` button.

7. Click the green `Run Model` button. Ensure that the `Size Limit Fix` box is checked. Click the green `Run Model` button.

8. Next, we must perform the age 2s from 3s procedure. If this is the first (i.e., most recent) year in the validation runs, press the green `FRAM Utilities` button.  Press the green `Compute 2s From 3s (Chin)` button. When the pop up appears, click `Yes`.  On the next pop up, click the green `Replace Current Model Run` button.  In the next window click the green `EXIT` button. Proceed to the next step.
If the year you’re currently on is NOT the most recent year in validation runs, age 2s from 3s should be calculated using the age 3 abundances from year +1. We recommend using the supplied R code. See <a href="literature/“BY Age 2 from 3.R"> “BY Age 2 from 3.R” </a> for more information. To use the code properly, make sure the file path and name in code line 22 matches the location and name of the validation data base.  Also, ensure that the year in line 19 correctly matches the year you’re on. 

9. Click the green `Run Model` button. Ensure that the `Size Limit Fix` box is checked. Click the green `Select TAMM` button.  Choose the TAMM associated with the year being run. Click the green `Run Model` button. When the pop up appears, click `Yes` to paste values into the TAMM.

10. After the run is complete, open the TAMM on your task bar, and navigate to the `ER_ESC_Overview(ifanyMSF)` tab.  Check for ER differences with the previous run in cells AC7:AF35.  If ER differences are minor (I usually aim for less than 5 thousandths of a percent in all stocks), move to the next year (year = year - 1).  If they are greater than 5 thousandths of a percent, cells B7:E35 should be copied and pasted into cells AH6:AK35. Then steps 4-10 should be repeated until ER differences are less than 5 thousandths of a percent for all stocks.

11. Implement additional TAMM procedures<br>

* South Puget Sound Iterations 
* North of Ayock/South of Ayock Splits 

See <a href="https://framverse.github.io/fram_doc/user_main_menu_full.html#Chinook70" target="_blank">User Manual </a> for more information.

##### New Base Period Running Procedures

Complete steps above, but do not check size limit box.  

##### [QAQC]{#QAQC}

* Check BKFRAM Targets vs. Outputs 
* Check 2s from 3s 
* Check TAMM ERs vs. Last Iteration 

##### [Errors Encountered]{#errors}

The purpose of this section is to describe errors encountered during post-season runs, potential causes, and potential solutions.  This is an incomplete list and it is possible to experience problems that differ from those described below.

1.)	Error message while conducting a forward run with TAMM 

TAMM values not converging<br>
This situation is typically caused by a fish scalar of zero during a time with catch in the validation run database/TAMM. To identify where the issue occurs, see the FRAMcheck.txt file in the folder where the validation run database is located.  By scrolling through the text file, it is possible to identify the fishery for which values do not converge. Once the fishery has been identified, ensure that the fishery flags are correct in the validation run database and that the scalar is not equal to 0 (for a fix set to 1).

2.)	Terminal run size does not converge with the terminal run size inputs during BKFRAM

This is typically caused by incorrect BKFRAM flags. For the stock that does not converge, identify the stock ID in terms of its BKFRAM stock ID. This is done by taking the stock number in the 38 stock format and multiplying it by 3 (total; times 3+1 for unmarked; times 3+2 for marked).  For example, Willapa is stock 37 and becomes stocks 111-113 in BKFRAM.  Convergence issues can generally be fixed by changing the BKtarget flag from a 3->1 within the validation run database.  If the flag is already a 1, and there are convergence issues, replace it with a 3.


